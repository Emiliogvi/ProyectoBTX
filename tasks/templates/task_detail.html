{% extends 'base.html' %}

{% block content %}

<div class="container-xxl mt-4 mb-4">
  <div class="row g-4">
    <!-- Columna izquierda - Gráfica + resultados -->
    <div class="col-lg-8">

      <!-- Card: Modelo causal + metadatos -->
      <div class="card shadow-sm border-0 soft-card mb-4">
        <div class="card-body">

          <!-- Encabezado registro -->
          <div class="d-flex flex-wrap justify-content-between align-items-start mb-3">
            <div>
              <h1 class="h4 fw-semibold mb-1 task-hero-title">
                {{ task.title }}
              </h1>
              <p class="text-muted mb-1 small">
                ID Registro #{{ task.id }} · Usuario {{ task.user.username }}
              </p>
              {% if task.ubicacion %}
              <span class="badge rounded-pill bg-light text-muted border small">
                <i class="fas fa-map-marker-alt me-1 text-primary"></i>
                {{ task.ubicacion }}
              </span>
              {% endif %}
            </div>
            <div class="text-end">
              <div class="mt-2 small text-muted">
                <div>
                  <strong>Creado:</strong>
                  {{ task.created|date:"d/m/Y" }} · {{ task.created|date:"H:i" }}
                </div>
                {% if task.datecompleted %}
                <div>
                  <strong>Finalizado:</strong>
                  {{ task.datecompleted|date:"d/m/Y H:i" }}
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <hr class="text-muted" style="opacity:.2;">

          <!-- Gráfica del modelo causal -->
          <div class="causal-model-wrapper">
            <div class="causal-model-container">
              <img src="{% url 'causal_graph_jpg' %}?v={{ task.created|date:'U' }}"
                   alt="Modelo Causal BTX"
                   class="causal-model-img img-fluid"
                   id="causalModel">
            </div>
            <p class="text-muted text-center small mt-2 mb-0">
              Representación del modelo dinámico de causalidad de gases BTX y efectos en la salud.
            </p>
          </div>

          <!-- Información adicional de la tarea -->
          <div class="task-details mt-4">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="info-item">
                  <span class="info-label">ID del Registro</span>
                  <span class="info-value">#{{ task.id }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Usuario responsable</span>
                  <span class="info-value">{{ task.user.username }}</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-item">
                  <span class="info-label">Creado</span>
                  <span class="info-value">
                    {{ task.created|date:"d/m/Y" }} · {{ task.created|date:"H:i" }}
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">Tipo de simulación</span>
                  <span class="info-value">
                    <span class="badge bg-primary text-light">BTX</span>
                  </span>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- GRÁFICAS DE ANÁLISIS -->
      {% if resultados_txt %}
      <div class="card shadow-sm border-0 soft-card mb-4">
        <div class="card-body">
          <h5 class="card-title mb-3 h6 fw-semibold">
            <i class="fas fa-chart-bar me-2 text-primary"></i>Análisis visual de datos BTX
          </h5>

          <!-- Gráfica 1: Dispersión con línea de regresión -->
          <div class="mb-4">
            <h6 class="fw-semibold mb-2 small text-muted text-uppercase">
              Relación BTX – Casos respiratorios
            </h6>
            {% if datos_graficas.datos_disponibles and datos_graficas.dispersion.btx_total and datos_graficas.dispersion.casos_respiratorios %}
            <div class="chart-container" style="position: relative; height:360px; width:100%">
              <canvas id="grafico-btx-salud"></canvas>
            </div>
            <p class="small text-muted mt-2 mb-0">
              Cada punto representa una observación de concentración BTX frente al número de casos
              respiratorios asociados en el periodo de análisis.
            </p>
            {% else %}
            <div class="alert alert-warning text-center small mb-0">
              <i class="fas fa-exclamation-triangle me-2"></i>
              No hay datos suficientes para generar esta gráfica. Se requieren archivos de
              <strong>Emisiones</strong> y <strong>Salud</strong> con datos válidos.
            </div>
            {% endif %}
          </div>

          <hr class="text-muted" style="opacity:.15;">

          <!-- Gráfica 2: Mapa de calor de correlaciones -->
          <div>
            <h6 class="fw-semibold mb-2 small text-muted text-uppercase">
              Mapa de correlaciones BTX vs variables ambientales y de salud
            </h6>
            {% if datos_graficas.datos_disponibles and datos_graficas.correlaciones.variables and datos_graficas.correlaciones.matriz %}
            <div class="chart-container" style="position: relative; height:420px; width:100%">
              <canvas id="grafico-correlograma"></canvas>
            </div>
            <p class="small text-muted mt-2 mb-0">
              Los valores representan coeficientes de correlación entre -1 y 1. Los tonos cálidos indican
              correlación positiva y los tonos fríos correlación negativa.
            </p>
            {% else %}
            <div class="alert alert-warning text-center small mb-0">
              <i class="fas fa-exclamation-triangle me-2"></i>
              No hay datos suficientes para generar el mapa de correlaciones. Se requieren múltiples
              archivos con variables ambientales y de salud.
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- RESULTADOS TXT -->
      {% if resultados_txt %}
      <div class="card shadow-sm border-0 soft-card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h5 class="card-title mb-0 h6 fw-semibold">
              <i class="fas fa-chart-line me-2 text-primary"></i>Resultados del análisis BTX
            </h5>
            <button class="btn btn-primary btn-sm" id="descargarResultadosBtn">
              <i class="fas fa-download me-2"></i>Descargar TXT
            </button>
          </div>

          <div class="resultados-container">
            <pre class="resultados-txt">{{ resultados_txt }}</pre>
          </div>
        </div>
      </div>
      {% else %}
      <div class="card shadow-sm border-0 soft-card mb-4">
        <div class="card-body text-center">
          <div class="alert alert-info mb-2">
            <i class="fas fa-info-circle me-2"></i>
            No hay resultados de análisis disponibles para esta simulación.
          </div>
          <p class="text-muted small mb-0">
            Los resultados se generan automáticamente al finalizar la simulación desde la página
            de creación.
          </p>
        </div>
      </div>
      {% endif %}

      <!-- ARCHIVOS DE LA SIMULACIÓN -->
      <div class="card shadow-sm border-0 soft-card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <div>
              <h5 class="card-title mb-0 h6 fw-semibold">
                Archivos de la simulación
              </h5>
              <p class="text-muted small mb-0">
                {{ task.title }} ·
                <span class="fw-semibold">{{ archivos_simulacion|length }}</span>
                archivo(s) asociado(s)
              </p>
            </div>
          </div>

          {% if archivos_simulacion %}
          <div class="table-responsive">
            <table class="table align-middle table-sm mb-3">
              <thead class="table-light">
                <tr>
                  <th>Nombre del archivo</th>
                  <th>Tipo</th>
                  <th>Fecha de carga</th>
                  <th>Tamaño</th>
                  <th>Validación</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for archivo in archivos_simulacion %}
                <tr>
                  <td>
                    <i class="fas fa-file-excel text-success me-2"></i>
                    <span class="small">{{ archivo.archivo.name|slice:"15:" }}</span>
                  </td>
                  <td>
                    <span class="badge bg-info-subtle text-info-emphasis border small">
                      {{ archivo.tipo_tabla }}
                    </span>
                  </td>
                  <td class="small text-muted">
                    {{ archivo.fecha_carga|date:"d/m/Y H:i" }}
                  </td>
                  <td class="small text-muted">
                    {% if archivo.archivo.size %}
                      {{ archivo.archivo.size|filesizeformat }}
                    {% else %}
                      Desconocido
                    {% endif %}
                  </td>
                  <td>
                    {% if archivo.valido %}
                      <span class="badge bg-success text-light small">Válido</span>
                    {% else %}
                      <span class="badge bg-danger text-light small">Inválido</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <a href="{{ archivo.archivo.url }}"
                       class="btn btn-sm btn-primary rounded-3 me-1"
                       download>
                      <i class="fas fa-download me-1"></i>Descargar
                    </a>
                    <a href="{% url 'delete_archivo' archivo.id %}"
                       class="btn btn-sm btn-outline-danger rounded-3"
                       onclick="return confirm('¿Eliminar este archivo?')">
                      <i class="fas fa-trash me-1"></i>Eliminar
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-info text-center small mb-0">
            <i class="fas fa-info-circle me-2"></i>
            No hay archivos asociados a esta simulación.
          </div>
          {% endif %}

          <!-- Formulario para agregar más archivos -->
          <div class="mt-4">
            <h6 class="fw-semibold small mb-2 text-muted text-uppercase">
              Agregar archivos a esta simulación
            </h6>
            <form method="POST"
                  action="{% url 'add_archivo_simulacion' task.id %}"
                  enctype="multipart/form-data"
                  class="row g-3 align-items-center">
              {% csrf_token %}
              <div class="col-md-4">
                <select name="tipo_tabla" class="form-select form-select-sm" required>
                  <option value="">Seleccionar tipo...</option>
                  <option value="Emisiones">Emisiones</option>
                  <option value="Dispersión">Dispersión Atmosférica</option>
                  <option value="Exposición">Exposición Poblacional</option>
                  <option value="Salud">Salud Respiratoria</option>
                  <option value="Social">Respuesta Social y Regulatoria</option>
                </select>
              </div>
              <div class="col-md-5">
                <input type="file"
                       name="archivo_excel"
                       class="form-control form-control-sm"
                       accept=".xlsx,.xls,.csv"
                       required>
              </div>
              <div class="col-md-3">
                <button type="submit" class="btn btn-primary btn-sm w-100 rounded-3">
                  <i class="fas fa-plus me-1"></i>Agregar archivo
                </button>
              </div>
            </form>
          </div>

        </div>
      </div>
    </div>

    <!-- Columna derecha - Acciones -->
    <div class="col-lg-4">
      <!-- Acciones de descarga -->
      <div class="card shadow-sm border-0 soft-card mb-4">
        <div class="card-body">
          <h5 class="card-title text-center mb-3 h6 fw-semibold">
            <i class="fas fa-download me-2 text-primary"></i>Descargas disponibles
          </h5>

          <!-- Botones de descarga -->
          <div class="download-buttons">
            <button class="btn btn-primary w-100 mb-3 btn-sm rounded-3"
                    id="downloadJPG">
              <i class="fas fa-image me-2"></i>Descargar gráfica JPG
            </button>
            
            {% if resultados_txt %}
            <button class="btn btn-primary w-100 mb-3 btn-sm rounded-3"
                    id="descargarTxtSidebar">
              <i class="fas fa-file-alt me-2"></i>Descargar resultados TXT
            </button>
            {% endif %}

            <p class="text-muted small mb-0 text-center">
              Descarga la gráfica del modelo causal y los resultados del análisis.
            </p>
          </div>
        </div>
      </div>

      <!-- Gestión del registro -->
      <div class="card shadow-sm border-0 soft-card">
        <div class="card-body">
          <h6 class="card-title mb-3 h6 fw-semibold text-center">
            Gestión del registro
          </h6>

          {% if error %}
          <div class="alert alert-danger small">{{ error }}</div>
          {% endif %}

          <!-- Eliminar registro -->
          <div class="d-grid gap-2">
            <button class="btn btn-danger w-100 btn-sm rounded-3"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteModal">
              <i class="fas fa-trash me-2"></i>Eliminar registro
            </button>
          </div>

          <div class="mt-3 text-center">
            <p class="text-muted small mb-0">
              Esta acción eliminará permanentemente la simulación y todos sus archivos asociados.
            </p>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content soft-card">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Advertencia:</strong> esta acción no se puede deshacer.
        </div>
        <p class="mb-1">
          ¿Estás seguro de que deseas eliminar permanentemente el registro
          <strong>"{{ task.title }}"</strong>?
        </p>
        <p class="text-muted small mb-0">
          Se eliminarán todos los datos asociados, incluyendo archivos Excel y resultados generados.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button"
                class="btn btn-outline-secondary btn-sm"
                data-bs-dismiss="modal">
          Cancelar
        </button>
        <form action="{% url 'delete_task' task.id %}" method="POST">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger btn-sm">
            Sí, eliminar definitivamente
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Scripts para gráficas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- Datos para las gráficas desde Django ---
const datosGraficas = {
  dispersion: {
    btx_total: {{ datos_graficas.dispersion.btx_total|default:"[]"|safe }},
    casos_respiratorios: {{ datos_graficas.dispersion.casos_respiratorios|default:"[]"|safe }}
  },
  correlaciones: {
    variables: {{ datos_graficas.correlaciones.variables|default:"[]"|safe }},
    matriz: {{ datos_graficas.correlaciones.matriz|default:"[]"|safe }}
  },
  datos_disponibles: {{ datos_graficas.datos_disponibles|yesno:"true,false" }}
};

// Gráfica 1: Dispersión con línea de regresión
function inicializarGraficaDispersion() {
  const canvas = document.getElementById('grafico-btx-salud');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');

  if (!datosGraficas.dispersion.btx_total ||
      !datosGraficas.dispersion.casos_respiratorios ||
      datosGraficas.dispersion.btx_total.length < 2 ||
      datosGraficas.dispersion.casos_respiratorios.length < 2) {
    console.warn('Datos insuficientes para gráfica de dispersión', datosGraficas.dispersion);
    return;
  }

  const scatterData = [];
  for (let i = 0; i < datosGraficas.dispersion.btx_total.length; i++) {
    scatterData.push({
      x: parseFloat(datosGraficas.dispersion.btx_total[i]) || 0,
      y: parseFloat(datosGraficas.dispersion.casos_respiratorios[i]) || 0
    });
  }

  const xValues = datosGraficas.dispersion.btx_total.map(x => parseFloat(x) || 0);
  const yValues = datosGraficas.dispersion.casos_respiratorios.map(y => parseFloat(y) || 0);
  const regression = calcularRegresionLineal(xValues, yValues);

  const minX = Math.min(...xValues);
  const maxX = Math.max(...xValues);
  const lineData = [
    { x: minX, y: regression.slope * minX + regression.intercept },
    { x: maxX, y: regression.slope * maxX + regression.intercept }
  ];

  new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Datos observados',
          data: scatterData,
          backgroundColor: 'rgba(54, 162, 235, 0.7)',
          borderColor: 'rgba(54, 162, 235, 1)',
          pointRadius: 5,
          pointHoverRadius: 7
        },
        {
          label: 'Línea de regresión',
          data: lineData,
          type: 'line',
          backgroundColor: 'rgba(255, 99, 132, 0.1)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 2,
          pointRadius: 0,
          fill: false,
          tension: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { font: { size: 11 } }
        },
        tooltip: {
          callbacks: {
            label: (context) => {
              const p = context.raw;
              return `BTX: ${p.x.toFixed(2)} µg/m³ · Casos: ${p.y.toFixed(0)}`;
            }
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'BTX total (µg/m³)' },
          type: 'linear',
          position: 'bottom'
        },
        y: {
          title: { display: true, text: 'Casos respiratorios' },
          type: 'linear'
        }
      }
    }
  });
}

// Gráfica 2: Mapa de calor de correlaciones
function inicializarGraficaCorrelograma() {
  const canvas = document.getElementById('grafico-correlograma');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const variables = datosGraficas.correlaciones.variables;
  const matriz = datosGraficas.correlaciones.matriz;

  if (!variables || !matriz || variables.length === 0 || matriz.length === 0) {
    console.warn('Datos insuficientes para mapa de correlaciones', datosGraficas.correlaciones);
    return;
  }

  const labels = variables;
  const data = {
    labels: labels,
    datasets: [{
      label: 'Matriz de correlación',
      data: [],
      backgroundColor: []
    }]
  };

  for (let i = 0; i < variables.length; i++) {
    for (let j = 0; j < variables.length; j++) {
      const value = matriz[i][j];
      data.datasets[0].data.push({
        x: variables[j],
        y: variables[i],
        v: value
      });
      data.datasets[0].backgroundColor.push(getColorForValue(value));
    }
  }

  new Chart(ctx, {
    type: 'scatter',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: (context) => {
              const p = context.raw;
              const value = p.v;
              let interpretacion = '';
              if (value >= 0.8) interpretacion = ' (correlación muy fuerte positiva)';
              else if (value >= 0.6) interpretacion = ' (correlación fuerte positiva)';
              else if (value >= 0.4) interpretacion = ' (correlación moderada positiva)';
              else if (value >= 0.2) interpretacion = ' (correlación débil positiva)';
              else if (value >= -0.2) interpretacion = ' (sin correlación significativa)';
              else if (value >= -0.4) interpretacion = ' (correlación débil negativa)';
              else if (value >= -0.6) interpretacion = ' (correlación moderada negativa)';
              else if (value >= -0.8) interpretacion = ' (correlación fuerte negativa)';
              else interpretacion = ' (correlación muy fuerte negativa)';
              return `${p.y} vs ${p.x}: ${value.toFixed(2)}${interpretacion}`;
            }
          }
        }
      },
      scales: {
        x: {
          type: 'category',
          labels: labels,
          title: { display: true, text: 'Variables' }
        },
        y: {
          type: 'category',
          labels: labels,
          title: { display: true, text: 'Variables' }
        }
      }
    }
  });
}

// Regresión lineal
function calcularRegresionLineal(x, y) {
  const n = x.length;
  const sumX = x.reduce((a, b) => a + b, 0);
  const sumY = y.reduce((a, b) => a + b, 0);
  const sumXY = x.reduce((s, xi, i) => s + xi * y[i], 0);
  const sumXX = x.reduce((s, xi) => s + xi * xi, 0);

  const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;

  return { slope, intercept };
}

// Color según valor de correlación
function getColorForValue(value) {
  const absValue = Math.abs(value);
  if (value >= 0) {
    const intensity = Math.min(200, Math.floor(absValue * 255));
    return `rgba(255, ${120 - intensity/2}, ${120 - intensity/2}, 0.85)`;
  } else {
    const intensity = Math.min(200, Math.floor(absValue * 255));
    return `rgba(${120 - intensity/2}, ${120 - intensity/2}, 255, 0.85)`;
  }
}

// Inicializar gráficas
document.addEventListener('DOMContentLoaded', () => {
  if (datosGraficas.datos_disponibles) {
    if (document.getElementById('grafico-btx-salud')) {
      inicializarGraficaDispersion();
    }
    if (document.getElementById('grafico-correlograma')) {
      inicializarGraficaCorrelograma();
    }
  }
});
</script>

<style>
  :root{
    --btx-blue:#28537E;
    --btx-blue-light:#3d6a9e;
    --btx-blue-dark:#1f3f5f;
    --btx-white:#ffffff;
    --btx-gray-050:#f9fafb;
    --btx-gray-100:#f3f4f6;
    --btx-gray-200:#e5e7eb;
    --btx-gray-400:#9ca3af;
    --btx-gray-700:#374151;
    --btx-shadow-sm:0 2px 8px rgba(15,23,42,0.04);
    --btx-shadow-md:0 4px 16px rgba(15,23,42,0.08);
    --btx-shadow-lg:0 12px 32px rgba(15,23,42,0.12);
  }

  .soft-card{
    border-radius: 16px;
    box-shadow: var(--btx-shadow-md);
    border: 1px solid rgba(148,163,184,.15);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .soft-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--btx-shadow-lg);
  }

  .task-hero-title{
    color: var(--btx-gray-700);
    font-weight: 700;
  }

  .causal-model-wrapper{
    background: linear-gradient(180deg, var(--btx-gray-050) 0%, var(--btx-white) 60%);
    border-radius: 14px;
    padding: 20px;
    border: 1px solid var(--btx-gray-200);
  }

  .causal-model-container{
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .causal-model-img{
    border-radius: 12px;
    max-height: 380px;
    width: auto;
    box-shadow: var(--btx-shadow-lg);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .causal-model-img:hover{
    transform: scale(1.02);
    box-shadow: 0 16px 40px rgba(15,23,42,0.2);
    cursor: zoom-in;
  }

  .causal-model-img.zoomed{
    transform: scale(1.8);
    z-index: 1000;
    position: relative;
    cursor: zoom-out;
  }

  .task-details .info-item{
    padding: 12px 14px;
    border-radius: 12px;
    background: var(--btx-gray-050);
    border: 1px solid var(--btx-gray-200);
    font-size: .87rem;
    display: flex;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
  }

  .task-details .info-item:hover{
    background: var(--btx-white);
    border-color: var(--btx-blue);
    box-shadow: var(--btx-shadow-sm);
  }

  .task-details .info-label{
    color: var(--btx-gray-400);
    font-weight: 600;
  }

  .task-details .info-value{
    color: var(--btx-gray-700);
    font-weight: 500;
  }

  .download-buttons .btn{
    transition: all 0.2s ease;
    font-weight: 500;
  }

  .download-buttons .btn:hover{
    transform: translateY(-2px);
    box-shadow: var(--btx-shadow-md);
  }

  .resultados-container{
    background: var(--btx-gray-050);
    border-radius: 12px;
    padding: 16px;
    max-height: 380px;
    overflow-y: auto;
    border: 1px solid var(--btx-gray-200);
  }

  .resultados-txt{
    font-family: "JetBrains Mono","Courier New",monospace;
    font-size: .8rem;
    line-height: 1.4;
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: var(--btx-gray-700);
  }

  .chart-container{
    background: var(--btx-white);
    border-radius: 12px;
    padding: 16px;
    box-shadow: var(--btx-shadow-sm);
    border: 1px solid var(--btx-gray-200);
  }

  .chart-container canvas{
    width: 100% !important;
    height: 100% !important;
  }

  .bg-info-subtle{
    background-color: rgba(40, 83, 126, 0.1) !important;
  }
  .text-info-emphasis{
    color: var(--btx-blue) !important;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--btx-blue) 0%, var(--btx-blue-light) 100%);
    border: none;
    font-weight: 500;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, var(--btx-blue-dark) 0%, var(--btx-blue) 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(40, 83, 126, 0.3);
  }

  .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
    font-weight: 500;
  }

  .btn-outline-danger:hover {
    background-color: #dc3545;
    border-color: #dc3545;
    transform: translateY(-1px);
  }

  @media (max-width: 767.98px){
    .causal-model-img{
      max-height: 260px;
    }
    
    .soft-card {
      margin-bottom: 1rem;
    }
  }

  /* Animaciones sutiles */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .soft-card {
    animation: fadeIn 0.5s ease-out;
  }
</style>

<script>
  // --- Descarga JPG ---
  const btnJpg = document.getElementById('downloadJPG');
  if (btnJpg) {
    btnJpg.addEventListener('click', () => {
      const img = document.getElementById('causalModel');
      if (!img) return;
      const link = document.createElement('a');
      link.href = img.src;
      link.download = 'modelo_causal_btx.jpg';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  }

  // --- Descarga TXT (bloque principal) ---
  const btnTxtMain = document.getElementById('descargarResultadosBtn');
  if (btnTxtMain) {
    btnTxtMain.addEventListener('click', () => {
      const resultadosTxt = `{{ resultados_txt|escapejs }}`;
      const blob = new Blob([resultadosTxt], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `analisis_btx_{{task.title}}_{{task.id}}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  }

  // --- Descarga TXT (sidebar) ---
  const btnTxtSidebar = document.getElementById('descargarTxtSidebar');
  if (btnTxtSidebar) {
    btnTxtSidebar.addEventListener('click', () => {
      const resultadosTxt = `{{ resultados_txt|escapejs }}`;
      const blob = new Blob([resultadosTxt], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `analisis_btx_{{task.title}}_{{task.id}}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  }

  // --- Efecto zoom en imagen causal ---
  const causalImage = document.getElementById('causalModel');
  if (causalImage) {
    causalImage.addEventListener('mouseenter', function(){
      this.style.cursor = 'zoom-in';
    });
    causalImage.addEventListener('mouseleave', function(){
      if (!this.classList.contains('zoomed')) {
        this.style.cursor = 'default';
      }
    });
    causalImage.addEventListener('click', function(){
      if (this.classList.contains('zoomed')) {
        this.classList.remove('zoomed');
        this.style.transform = '';
        this.style.zIndex = '';
        this.style.position = '';
        this.style.cursor = 'zoom-in';
      } else {
        this.classList.add('zoomed');
        this.style.transform = 'scale(1.8)';
        this.style.zIndex = '1000';
        this.style.position = 'relative';
        this.style.cursor = 'zoom-out';
      }
    });
  }
</script>

{% endblock %}