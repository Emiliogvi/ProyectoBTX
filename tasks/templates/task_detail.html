{% extends 'base.html' %}

{% block content %}

<div class="container-fluid mt-4">
    <div class="row">
        <!-- Columna izquierda - Gráfica del modelo causal (2/3) -->
        <div class="col-md-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body text-center">
                    <h3 class="card-title mb-4">{{task.title}}</h3>
                    
                    <!-- Gráfica del modelo causal -->
                    <div class="causal-model-container">
                        <img src="{% url 'causal_graph_jpg' %}?v={{ task.created|date:'U' }}"
                            alt="Modelo Causal BTX"
                            class="causal-model-img img-fluid"
                            id="causalModel">
                    </div>
                    
                    <!-- Información adicional de la tarea -->
                    <div class="task-details mt-4">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <strong>ID del Registro:</strong> {{task.id}}
                                </div>
                                <div class="info-item">
                                    <strong>Usuario Responsable:</strong> {{task.user.username}}
                                </div>
                                <div class="info-item">
                                    <strong>Fecha de Creación:</strong> {{task.created|date:'d/m/Y'}}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <strong>Hora de Creación:</strong> {{task.created|date:'H:i'}}
                                </div>
                                {% if task.ubicacion %}
                                <div class="info-item">
                                    <strong>Ubicación:</strong> {{task.ubicacion}}
                                </div>
                                {% endif %}
                                <div class="info-item">
                                    <strong>Estado:</strong> 
                                    <span class="badge {% if task.datecompleted %}bg-success{% else %}bg-warning{% endif %}">
                                        {% if task.datecompleted %}Completado{% else %}Pendiente{% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NUEVA SECCIÓN: GRÁFICAS DE ANÁLISIS -->
            {% if resultados_txt %}
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-chart-bar me-2"></i>Análisis Visual de Datos BTX
                    </h5>
                    
                    <!-- Gráfica 1: Dispersión con línea de regresión -->
                    <div class="row mb-5">
                        <div class="col-12">
                            <h6 class="fw-semibold mb-3">Relación entre concentración BTX y casos respiratorios</h6>
                            <div class="chart-container" style="position: relative; height:400px; width:100%">
                                <canvas id="grafico-btx-salud"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Gráfica 2: Mapa de calor de correlaciones -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="fw-semibold mb-3">Mapa de correlaciones BTX vs variables ambientales y de salud</h6>
                            <div class="chart-container" style="position: relative; height:500px; width:100%">
                                <canvas id="grafico-correlograma"></canvas>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">Los valores representan coeficientes de correlación entre -1 y 1</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Sección de resultados del análisis -->
            {% if resultados_txt %}
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-chart-line me-2"></i>Resultados del Análisis BTX
                    </h5>
                    
                    <div class="resultados-container">
                        <pre class="resultados-txt">{{ resultados_txt }}</pre>
                    </div>
                    
                    <div class="mt-3 text-end">
                        <button class="btn btn-outline-primary" id="descargarResultadosBtn">
                            <i class="fas fa-download me-2"></i>Descargar Resultados TXT
                        </button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body text-center">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No hay resultados de análisis disponibles para esta simulación.
                    </div>
                    <p class="text-muted">Los resultados se generan automáticamente cuando se finaliza la simulación en la página de creación.</p>
                </div>
            </div>
            {% endif %}

            <!-- Sección de archivos de la simulación -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        Archivos de la Simulación: {{task.title}}
                        <small class="text-muted">({{ archivos_simulacion|length }} archivos)</small>
                    </h5>
                    
                    {% if archivos_simulacion %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nombre del Archivo</th>
                                    <th>Tipo</th>
                                    <th>Fecha de Carga</th>
                                    <th>Tamaño</th>
                                    <th>Estado Validación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for archivo in archivos_simulacion %}
                                <tr>
                                    <td>
                                        <i class="fas fa-file-excel text-success me-2"></i>
                                        {{ archivo.archivo.name|slice:"15:" }}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ archivo.tipo_tabla }}</span>
                                    </td>
                                    <td>{{ archivo.fecha_carga|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        {% if archivo.archivo.size %}
                                            {{ archivo.archivo.size|filesizeformat }}
                                        {% else %}
                                            Desconocido
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if archivo.valido %}
                                            <span class="badge bg-success">Válido</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inválido</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ archivo.archivo.url }}" class="btn btn-sm btn-outline-success" download>
                                            <i class="fas fa-download me-1"></i>Descargar
                                        </a>
                                        <a href="{% url 'delete_archivo' archivo.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar este archivo?')">
                                            <i class="fas fa-trash me-1"></i>Eliminar
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        No hay archivos asociados a esta simulación.
                    </div>
                    {% endif %}

                    <!-- Formulario para agregar más archivos -->
                    <div class="mt-4">
                        <h6>Agregar más archivos a esta simulación</h6>
                        <form method="POST" action="{% url 'add_archivo_simulacion' task.id %}" enctype="multipart/form-data" class="row g-3">
                            {% csrf_token %}
                            <div class="col-md-4">
                                <select name="tipo_tabla" class="form-select" required>
                                    <option value="">Seleccionar tipo...</option>
                                    <option value="Emisiones">Emisiones</option>
                                    <option value="Dispersión">Dispersión Atmosférica</option>
                                    <option value="Exposición">Exposición Poblacional</option>
                                    <option value="Salud">Salud Respiratoria</option>
                                    <option value="Social">Respuesta Social y Regulatoria</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <input type="file" name="archivo_excel" class="form-control" accept=".xlsx,.xls,.csv" required>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-plus me-1"></i>Agregar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna derecha - Datos numéricos BTX (1/3) -->
        <div class="col-md-4">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <h5 class="card-title text-center mb-4">
                        <i class="fas fa-flask me-2"></i>Datos BTX - Indicadores
                    </h5>
                    
                    <!-- Datos numéricos del análisis -->
                    <div class="btx-data">
                        <div class="data-item">
                            <strong>Concentración Benceno:</strong> 
                            <span class="float-end">{{ btx_data.concentracion_benzeno|floatformat:2 }} µg/m³</span>
                        </div>
                        <div class="data-item">
                            <strong>Concentración Tolueno:</strong> 
                            <span class="float-end">{{ btx_data.concentracion_tolueno|floatformat:2 }} µg/m³</span>
                        </div>
                        <div class="data-item">
                            <strong>Concentración Xileno:</strong> 
                            <span class="float-end">{{ btx_data.concentracion_xileno|floatformat:2 }} µg/m³</span>
                        </div>
                        <div class="data-item">
                            <strong>BTX Total:</strong> 
                            <span class="float-end">{{ btx_data.btx_total|default:"8.5"|floatformat:2 }} µg/m³</span>
                        </div>
                        <div class="data-item">
                            <strong>Casos Respiratorios:</strong> 
                            <span class="float-end">{{ btx_data.casos_totales|default:"1570" }}</span>
                        </div>
                    </div>

                    <!-- Botones de descarga -->
                    <div class="download-buttons mt-4">
                        {% if archivos_simulacion %}
                            {% for archivo in archivos_simulacion %}
                            <a href="{{ archivo.archivo.url }}" class="btn btn-outline-success w-100 mb-2" download>
                                <i class="fas fa-file-excel me-2"></i>Descargar {{ archivo.tipo_tabla }}
                            </a>
                            {% endfor %}
                        {% else %}
                            <button class="btn btn-outline-success w-100 mb-2" disabled>
                                <i class="fas fa-file-excel me-2"></i>No hay archivos
                            </button>
                        {% endif %}
                        
                        <button class="btn btn-outline-primary w-100 mb-2" id="downloadJPG">
                            <i class="fas fa-image me-2"></i>Descargar Gráfica JPG
                        </button>
                        
                        {% if resultados_txt %}
                        <button class="btn btn-outline-info w-100 mb-2" id="downloadTXT">
                            <i class="fas fa-file-alt me-2"></i>Descargar Resultados TXT
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Formularios de acciones -->
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h6 class="card-title">Acciones del Registro</h6>
                    
                    <!-- Formulario de actualización -->
                    {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                    {% endif %}

                    <form method="POST" class="mb-3">
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ form.as_p }}
                        </div>
                        <button class="btn btn-warning w-100">
                            <i class="fas fa-edit me-2"></i>Actualizar
                        </button>
                    </form>

                    <!-- Botones de completar y eliminar -->
                    <div class="d-grid gap-2">
                        <form action="{% url 'complete_task' task.id %}" method="POST">
                            {% csrf_token %}
                            <button class="btn btn-success w-100">
                                <i class="fas fa-check me-2"></i>Completar
                            </button>
                        </form>

                        <button class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="fas fa-trash me-2"></i>Eliminar Registro
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>¡Advertencia!</strong> Esta acción no se puede deshacer.
                </div>
                <p>¿Estás seguro de que quieres eliminar permanentemente el registro <strong>"{{task.title}}"</strong>?</p>
                <p class="text-muted">Se eliminarán todos los datos asociados, incluyendo archivos Excel y resultados.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form action="{% url 'delete_task' task.id %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Sí, Eliminar Permanentemente</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts para gráficas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Datos de ejemplo para las gráficas (debes reemplazar con datos reales de Django)
const datosGraficas = {
    dispersion: {
        btx_total: [8.5, 9.2, 7.8, 10.1, 8.9, 9.5, 7.2, 10.5, 8.3, 9.8],
        casos_respiratorios: [1200, 1350, 1100, 1450, 1300, 1400, 1050, 1500, 1250, 1420]
    },
    correlaciones: {
        variables: ['Benceno', 'Tolueno', 'Xileno', 'BTX Total', 'Velocidad Viento', 'Temperatura', 'Casos Asma', 'Hospitalizaciones'],
        matriz: [
            [1.00, 0.85, 0.78, 0.95, -0.45, 0.32, 0.88, 0.72],
            [0.85, 1.00, 0.82, 0.92, -0.38, 0.28, 0.79, 0.68],
            [0.78, 0.82, 1.00, 0.89, -0.42, 0.35, 0.75, 0.65],
            [0.95, 0.92, 0.89, 1.00, -0.48, 0.38, 0.91, 0.78],
            [-0.45, -0.38, -0.42, -0.48, 1.00, -0.15, -0.52, -0.41],
            [0.32, 0.28, 0.35, 0.38, -0.15, 1.00, 0.35, 0.28],
            [0.88, 0.79, 0.75, 0.91, -0.52, 0.35, 1.00, 0.85],
            [0.72, 0.68, 0.65, 0.78, -0.41, 0.28, 0.85, 1.00]
        ]
    }
};

// Gráfica 1: Dispersión con línea de regresión
function inicializarGraficaDispersion() {
    const ctx = document.getElementById('grafico-btx-salud').getContext('2d');
    
    // Calcular línea de regresión
    const regression = calcularRegresionLineal(
        datosGraficas.dispersion.btx_total, 
        datosGraficas.dispersion.casos_respiratorios
    );
    
    const lineaRegresion = datosGraficas.dispersion.btx_total.map(x => regression.slope * x + regression.intercept);
    
    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: 'Datos Observados',
                    data: datosGraficas.dispersion.btx_total.map((x, i) => ({
                        x: x,
                        y: datosGraficas.dispersion.casos_respiratorios[i]
                    })),
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    pointRadius: 6,
                    pointHoverRadius: 8
                },
                {
                    label: 'Línea de Regresión',
                    data: datosGraficas.dispersion.btx_total.map((x, i) => ({
                        x: x,
                        y: lineaRegresion[i]
                    })),
                    type: 'line',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Relación entre concentración BTX y casos respiratorios',
                    font: {
                        size: 16
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `BTX: ${context.parsed.x.toFixed(2)} µg/m³, Casos: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'BTX Total (µg/m³)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Casos Respiratorios'
                    }
                }
            }
        }
    });
}

// Gráfica 2: Mapa de calor de correlaciones (versión simple y funcional)
function inicializarGraficaCorrelograma() {
    const ctx = document.getElementById('grafico-correlograma').getContext('2d');
    
    const variables = datosGraficas.correlaciones.variables;
    const matriz = datosGraficas.correlaciones.matriz;
    
    // Crear datos para el heatmap simple
    const datasets = variables.map((variable, index) => {
        return {
            label: variable,
            data: matriz[index],
            backgroundColor: function(context) {
                const value = context.raw;
                return getColorForValue(value);
            },
            borderColor: 'white',
            borderWidth: 1,
            borderSkipped: false,
        };
    });

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: variables,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Mapa de correlaciones BTX vs variables ambientales y de salud',
                    font: {
                        size: 16
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            let interpretacion = '';
                            if (value >= 0.8) interpretacion = ' (Correlación muy fuerte positiva)';
                            else if (value >= 0.6) interpretacion = ' (Correlación fuerte positiva)';
                            else if (value >= 0.4) interpretacion = ' (Correlación moderada positiva)';
                            else if (value >= 0.2) interpretacion = ' (Correlación débil positiva)';
                            else if (value >= -0.2) interpretacion = ' (Sin correlación significativa)';
                            else if (value >= -0.4) interpretacion = ' (Correlación débil negativa)';
                            else if (value >= -0.6) interpretacion = ' (Correlación moderada negativa)';
                            else if (value >= -0.8) interpretacion = ' (Correlación fuerte negativa)';
                            else interpretacion = ' (Correlación muy fuerte negativa)';
                            
                            return `${context.dataset.label}: ${value.toFixed(2)}${interpretacion}`;
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'right',
                    labels: {
                        boxWidth: 12,
                        padding: 10,
                        font: {
                            size: 11
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: false,
                    title: {
                        display: true,
                        text: 'Variables'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    min: -1,
                    max: 1,
                    title: {
                        display: true,
                        text: 'Coeficiente de Correlación'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1);
                        }
                    }
                }
            }
        }
    });
}

// Función auxiliar para calcular regresión lineal
function calcularRegresionLineal(x, y) {
    const n = x.length;
    const sumX = x.reduce((a, b) => a + b, 0);
    const sumY = y.reduce((a, b) => a + b, 0);
    const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
    const sumXX = x.reduce((sum, xi) => sum + xi * xi, 0);
    
    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    
    return { slope, intercept };
}

// Función auxiliar para obtener color basado en el valor de correlación
function getColorForValue(value) {
    const absValue = Math.abs(value);
    
    if (value >= 0) {
        // Escala de rojos para positivos (más intenso = más rojo)
        const intensity = Math.floor(value * 200);
        return `rgba(255, ${100 - intensity}, ${100 - intensity}, 0.8)`;
    } else {
        // Escala de azules para negativos (más intenso = más azul)
        const intensity = Math.floor(absValue * 200);
        return `rgba(${100 - intensity}, ${100 - intensity}, 255, 0.8)`;
    }
}

// Inicializar gráficas cuando el documento esté listo
document.addEventListener('DOMContentLoaded', function() {
    // Solo inicializar gráficas si los elementos existen
    if (document.getElementById('grafico-btx-salud')) {
        inicializarGraficaDispersion();
    }
    if (document.getElementById('grafico-correlograma')) {
        inicializarGraficaCorrelograma();
    }
});
</script>

<style>
    .causal-model-container {
        padding: 20px;
        background: #f8f9fa;
        border-radius: 15px;
        margin-bottom: 20px;
    }
    .causal-model-img {
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        max-height: 400px;
        width: auto;
    }
    .causal-model-img:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    .btx-data {
        max-height: 400px;
        overflow-y: auto;
    }
    .data-item {
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
        font-size: 0.9em;
    }
    .data-item:last-child {
        border-bottom: none;
    }
    .info-item {
        margin-bottom: 10px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 5px;
        font-size: 0.9em;
    }
    .download-buttons .btn {
        transition: all 0.3s ease;
    }
    .download-buttons .btn:hover:not(:disabled) {
        transform: translateY(-2px);
    }
    .download-buttons .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    .card {
        border-radius: 15px;
    }
    .card-body {
        padding: 25px;
    }
    .resultados-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
    }
    .resultados-txt {
        font-family: 'Courier New', monospace;
        font-size: 0.85em;
        line-height: 1.4;
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
</style>

<script>
    // Funcionalidad para las descargas
    document.getElementById('downloadJPG').addEventListener('click', function() {
        const imageUrl = document.getElementById('causalModel').src;
        const link = document.createElement('a');
        link.href = imageUrl;
        link.download = 'modelo_causal_btx.jpg';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    document.getElementById('downloadTXT').addEventListener('click', function() {
        const resultadosTxt = `{{ resultados_txt|escapejs }}`;
        const blob = new Blob([resultadosTxt], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `resultados_btx_{{task.title}}_{{task.id}}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    document.getElementById('descargarResultadosBtn').addEventListener('click', function() {
        const resultadosTxt = `{{ resultados_txt|escapejs }}`;
        const blob = new Blob([resultadosTxt], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `analisis_btx_{{task.title}}_{{task.id}}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    // Efecto de hover mejorado para la imagen
    const causalImage = document.getElementById('causalModel');
    causalImage.addEventListener('mouseenter', function() {
        this.style.cursor = 'zoom-in';
    });
    
    causalImage.addEventListener('mouseleave', function() {
        this.style.cursor = 'default';
    });

    causalImage.addEventListener('click', function() {
        if (this.style.transform === 'scale(1.8)') {
            this.style.transform = 'scale(1)';
            this.style.zIndex = '1';
        } else {
            this.style.transform = 'scale(1.8)';
            this.style.zIndex = '1000';
            this.style.position = 'relative';
        }
    });
</script>

{% endblock %}